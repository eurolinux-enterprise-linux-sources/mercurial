diff --git a/mercurial/dispatch.py b/mercurial/dispatch.py
index d4cedee..93f96c4 100644
--- a/mercurial/dispatch.py
+++ b/mercurial/dispatch.py
@@ -38,6 +38,37 @@ def _runcatch(ui, args):
         if num: signal.signal(num, catchterm)
 
     try:
+        realcmd = None
+        try:
+            cmdargs = fancyopts.fancyopts(args[:], commands.globalopts, {})
+            cmd = cmdargs[0]
+            aliases, entry = cmdutil.findcmd(cmd, commands.table, False)
+            realcmd = aliases[0]
+        except (error.UnknownCommand, error.AmbiguousCommand,
+                IndexError, fancyopts.getopt.GetoptError):
+            # Don't handle this here. We know the command is
+            # invalid, but all we're worried about for now is that
+            # it's not a command that server operators expect to
+            # be safe to offer to users in a sandbox.
+            pass
+        if realcmd == 'serve' and '--stdio' in cmdargs:
+            # We want to constrain 'hg serve --stdio' instances pretty
+            # closely, as many shared-ssh access tools want to grant
+            # access to run *only* 'hg -R $repo serve --stdio'. We
+            # restrict to exactly that set of arguments, and prohibit
+            # any repo name that starts with '--' to prevent
+            # shenanigans wherein a user does something like pass
+            # --debugger or --config=ui.debugger=1 as a repo
+            # name. This used to actually run the debugger.
+            if (len(args) != 4 or
+                args[0] != '-R' or
+                args[1].startswith('--') or
+                args[2] != 'serve' or
+                args[3] != '--stdio'):
+                raise error.Abort(
+                    _('potentially unsafe serve --stdio invocation: %r') %
+                    (args,))
+
         try:
             # enter the debugger before command execution
             if '--debugger' in args:
